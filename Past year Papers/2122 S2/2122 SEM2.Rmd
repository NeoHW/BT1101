---
title: "2122 SEM2"
author: "BT1101 Student. Neo Haowei"
date: '25 Nov 2021, 1:00 - 3:30 PM'
output: html_document
---

## Question 1 : Profile Dashboard, Descriptive Statistics
## Question 2 : Linear Regression
## Question 3 : Linear Optimization


## Preparation

```{r preparation, echo=TRUE, warning = FALSE, message = FALSE}

library('libcoin')
library("rcompanion") #this package is required for transformTukey function
library("rstatix")
library("Rmisc") 
library("dplyr") #need to call the library before you use the package
library("tidyr")
library("rpivotTable")
library("knitr")
library("psych")
library(tidyverse)
library(ggplot2) 
library(TTR)
library(factoextra) # for fviz_cluster()
library(lpSolve)

# predictive/prescriptive analytics
library(tseries) 
library(forecast)
library(lpSolve)

# descriptive analytics
library(psych)
library(Rmisc)
library(rcompanion)
library(rpivotTable)
library(EnvStats) 
library(car)
library(rstatix)

# general use
library(dplyr)
library(tidyr)
library(knitr)
```

## Structured Question 1: CardioGood Fitness [Total 13 marks, marks indicated for each sub-question]
Context: The data and question is adapted from (https://www.kaggle.com/saurav9786/cardiogoodfitness). 

Your market research team at AdRight is assigned the task to identify the profile of the typical customer for each treadmill product offered by CardioGood Fitness. Your team decides to investigate whether there are differences across the product lines with respect to customer characteristics. The team decides to collect data on individuals who purchased a treadmill at a CardioGoodFitness retail store during the prior three months. 

The data are stored in the `CardioGoodFitness.csv` file. The team identifies the following customer variables to study: 

- `Product`: product purchased (TM195, TM498, or TM798)
- `Gender`: Female or Male
- `Age`: in years
- `Education`: number of years of education 
- `MaritalStatus`: Single or Partnered
- `Income`: annual household income ($)
- `Usage`: average number of times the customer plans to use the treadmill each week
- `Miles`: average number of miles the customer expects to walk/run each week
- `Fitness`: self-rated fitness on an 1-to-5 scale, where 1 is poor shape and 5 is excellent shape. 

You are tasked by your team to help in the tasks below towards creating a better understanding of the customer profile of the CardioGood Fitness treadmill product line.  

```{r data-read-in1, echo=T, eval=T}
## for Structured Question 1. Please check that the .csv file is in the same directory as your Rmd file.
# setwd("  ") (Make sure to set your directory if you get an error "cannot open connection")

d1 <- read.csv("CardioGoodFitness.csv")
#View(d1)

```


#### Q1.(a) Customer Profile by Product Dashboard (I).
This dashboard should enable the team to better understand the demographics of the customers for different types of treadmill products. 

- Create a table and chart to compare the frequency distributions for customer gender by different product types. Make sure you add the appropriate titles, legend and use different shades of one color as the color palette for the chart. [You are not required to perform outlier analyses for this question part]

[2 marks]

```{r q1a, echo=TRUE}
# Contingency Table
q1a <- d1 %>% group_by(Product,Gender) %>% count()
q1a.spread <- q1a %>% spread(key=Product,value=n)
q1a.spread[is.na(q1a.spread)]<-0 #convert NA to 0 value
kable(q1a.spread, caption = "Contingency table for Frequency distributions for customer gender by different product types")

# Grouped Barplot
barmatrix.b1<-as.matrix(q1a.spread[,c(2:4)])
bar_col1 <- c("lightgoldenrod1", "lightcoral")
bp1 <- barplot(barmatrix.b1, col=bar_col1,  main="Frequency distributions for customer gender by different product types", ylab="No. of Customers",  ylim=c(0,50), xlab = "Products", beside=TRUE) 
legend("topright", cex=0.6, fill=bar_col1, legend=q1a.spread$`Gender`)
text(bp1, 0, col = "black", barmatrix.b1, cex=1, pos=3) #creating numbers in the barplot
```


#### Q1.(b) Customer Profile by Product Dashboard (II).
Continuing on the dashboard you have created in 1a... 

- Create a table to compare the means for each of the following customer profile variables `Age`, `Education`, `Usage`, `Fitness`, `Income`, and `Miles`. This should be one table with each product along the rows and the means for each variable along the columns. From the table, how would you describe the customer profile for the 3 types of products? [You are not required to perform outlier analyses for this question part]

[3 marks]

```{r q1b, echo=TRUE}

q1b <- d1 %>% 
  group_by(Product) %>%
  summarise(Age=mean(Age),
            Education=mean(Education),
            Usage=mean(Usage),
            Fitness=mean(Fitness),
            Income=mean(Income),
            Miles=mean(Miles))
kable(q1b, row.names=FALSE, caption = "Means for each customer profile variables") 

```

<p style="color:blue">
TM195 is purchased by people with lowest mean `age`, lowest mean `education` and lowest mean `income`.  
TM498 is purchased by people with lowest mean `usage` and lowest mean `fitness`.  
TM798 is purchased by people with highest mean `age`, highest mean `education`, highest mean `usage`, highest mean `fitness`, highest mean `income` and highest mean `miles`.  
</p>


#### Q1.(c) Inspect Customer Income Data (I)

- Conduct an outlier analyses on the `Income` variable. Describe your conclusion from this analyses. 

[2 marks]

```{r q1c, echo=TRUE}

# Histogram
options(scipen = 999)
h1 <- hist(d1$Income,
           main="Histogram of annual household income ($)",
           xlab="annual household income",
           ylab="No. of people",
           col=c("darkorange"),
           ylim=c(0,60),
           xlim=c(0,120000),
           labels=TRUE)
options(scipen = 0)
# Normality
shapiro.test(d1$Income)

# Boxplot
onePointFiveIQROutliers <- boxplot(d1$Income, main='Boxplot with range = 1.5', horizontal =  TRUE)
threeIQROutliers <- boxplot(d1$Income, range=3, main='Boxplot with range = 3', horizontal =  TRUE)
mildOutliers <- setdiff(onePointFiveIQROutliers$out,threeIQROutliers$out) # Getting mild outliers  # setdiff(a,b) identifies values that are in a but not in b
extremeOutliers <- threeIQROutliers$out # Getting extreme outliers
mildOutliers
extremeOutliers
```

<p style="color:blue">
There are multiple entries outside of 1.5IQR, and 2 entries outside 3IQR.  
From shaprio wilks, p-value < 0.05 shows that data is not normally distributed. From historgram, there are no breaks in the data.  
For purchase of fitness equipment, there will be customers who have very high earning power; and the company would definitely target these customers.
Thus, we will not remove these entries for this outlier analysis.
</p>



#### Q1.(d) Inspect Customer Income Data (II)

- CardioGood Fitness believes that the actual proportion of customers with income more than $60,000 is less than 30%. Use the sample data to test this hypothesis.

[3 marks]

```{r q1d, echo=T}
q1d <- d1 %>% filter(Income>60000)
pIncome <- nrow(q1d)/nrow(d1)
z <- (pIncome - 0.3) / sqrt(0.3*(1-0.3)/nrow(d1)) # compute z-statistic for proportion
z
cv.income <- qnorm(0.05) # compute critical value
cv.income
```

<p style="color:blue">
Let p = proportion of customers with income more than $60,000  
H0: p >= 0.3  
H1: p < 0.3  
From our results (z-statistic=-1.9518 & z-critical=-1.64), the z-statistic is lying in the lower critical region. Thus we have sufficient evidence to reject H0 and accept that proportion of customers with income more than $60,000 is statistically less than 30% at the 5% level of significance.
</p>


#### Q1.(e) Conduct hypothesis testing.
You are asked to test if there is any difference in mean income of customers purchasing the 3 different types of treadmill.

- Set up the hypotheses (H0 & H1) and test your hypotheses. Describe the results and conclusions. In your answer be sure to explain clearly, how you arrived at your conclusion. 

[3 marks]

```{r q1e, echo=T}
q1e <- q1b %>% select(Product,Income)

wa.out1 <- d1 %>% welch_anova_test(Income ~ Product)
gh.out1 <- games_howell_test(d1, Income ~ Product)
wa.out1
gh.out1
```

<p style="color:blue">
H0: Mean income of customers is same across customers purchasing the 3 different types of treadmill.  
H1: Mean Income of customers for at least one type of purchased treadmill is different from the others.  
From Welch Anova test, Since p value of 8.64e-14<0.05, we have sufficient evidence to reject H0 in favour of H1.  
From Games Howell test, Income level between TM195 and TM798 are very different, Income level between TM498 and TM798 are very different.  
Thus, we can conclude statistically that Mean Income of customers for at least one type of purchased treadmill is different from the others.
</p>

# Structured Question 2 [Total 14 marks, marks indicated for each sub-question]

This question is based off a subset of the dataset collected in the following paper:

Harrison, David & Rubinfeld, Daniel. (1978). Hedonic housing prices and the demand for clean air. Journal of Environmental Economics and Management. 5. 81-102.

And is available at: https://www.kaggle.com/fedesoriano/the-boston-houseprice-data

This data consists of 506 neighborhoods and their associated variables. For this question we'll just look at three variables. 

-	`MedianValueInThousands`: Median value of owner-occupied homes, in $1,000's.
-	`PupilTeacherRatio`: pupil-teacher ratio in that neighborhood
-	`BordersRiver`: dummy variable that is 1 if neighborhood borders the river; 0 otherwise


```{r data-read-in2, echo=T, eval=T}
d2 <- read.csv("finalexam-housing.csv") %>% mutate(BordersRiver = factor(BordersRiver)) # READ QN!!! BordersRiver is FACTOR
```

### (a): 

(The dataset comes from a paper published in 1978, so let's imagine we're in 1978 now.) 
Your friend Jane is looking for a house in this city that the data comes from. Because she has young kids, her main priority is that the house has to be in a good school district. You see that in your dataset, you have a good proxy for education quality: the ratio of pupils to teachers, in `PupilTeacherRatio`.

What is the mean and standard deviation of `MedianValueInThousands`?

What is the mean and standard deviation of `PupilTeacherRatio`?

All else being equal, is a higher or lower `PupilTeacherRatio` better? Why?

[4 mark]

```{r q2a, echo=T}
d2 %>% summarise(mean=mean(MedianValueInThousands), sd=sd(MedianValueInThousands))
d2 %>% summarise(mean=mean(PupilTeacherRatio), sd=sd(PupilTeacherRatio))
```

<p style="color:blue">
Mean of `MedianValueInThousands` is : 22.53281  
Standard deviation of `MedianValueInThousands` is : 9.197104  
Mean of `PupilTeacherRatio` is : 18.45553	 
Standard deviation of `PupilTeacherRatio` is : 2.164946  
<br>
All else being equal, a lower `PupilTeacherRatio` is better as a lower ratio means lesser students to one teacher. The teacher will be able to direct and spend more time on each individual pupil.
</p>


### (b): 

Jane's other priority is that she wants to live near the river.

Using `PupilTeacherRatio` and `BordersRivers` as predictors, please fit a linear model to predict the median home price (`MedianValueInThousands`). 

Include your code in the textbox below. 

Interpret the intercept, and the coefficients on `PupilTeacherRatio` and `BordersRivers`, as we usually do in class. 

According to this model, what is the average price of a home in a neighborhood next to the river, with a pupil-to-teacher ratio that is one standard deviation better than the mean? 

Please write your answers as if to Jane, to explain what your findings are. 

[6 marks]

```{r q2b, echo=TRUE}

fit1 = lm(MedianValueInThousands ~ PupilTeacherRatio + BordersRiver, d2)
summary(fit1)

value = 18.45553 - 2.164946 # from q2a
# OR  value = mean(d2$PupilTeacherRatio) - sd(d2$PupilTeacherRatio)
value

price = 60.9579 + (-2.0977)*(16.29058) + 4.1735
price
```

<p style="color:blue">
Coefficient of Intercept = 60.9579. This suggests that when PupilTeacherRatio and the neighbourhood does not border the river, the medianValue of homes is 60.9579 thoursand dollars.  
The p-value=2e-16 is very small,(< 0.05), thus we have sufficient evidence to reject the null hypothesis that the intercept is 0 and conclude that the slope parameter is statistically significant at the 5% level of confidence.  
<br>
Coefficient of PupilTeacherRatio = -2.0977. Every unit increase of PupilTeacherRatio decreases the medianValue of homes by 2.0977 thousand dollars given all other predictors constant.  
The p-value=2e-16 is very small,(< 0.05), thus we have sufficient evidence to reject the null hypothesis that the intercept is 0 and conclude that the slope parameter is statistically significant at the 5% level of confidence.  
<br>
Coefficient of BordersRiver1 = 4.1735. If the neighbourhood borders the river, medianValue of homes increases by 4.1735 thousand dollars given all other predictors constant.  
The p-value=0.00279 is very small,(< 0.05), thus we have sufficient evidence to reject the null hypothesis that the intercept is 0 and conclude that the slope parameter is statistically significant at the 5% level of confidence.  
<br>
The average price of a home in a neighborhood next to the river, with a pupil-to-teacher ratio that is one standard deviation better than the mean is : 60.9579 + (-2.0977)*(16.29058) + 4.1735 = 30.95865 thousands dollar.  
</p>

### (c): 

You decide to explore fitting an interaction. Using the same two predictors as above, fit a model with the interaction.

Please interpret the coefficient on `PupilTeacherRatio`, as well as the coefficient on `PupilTeacherRatio:BordersRiver` (i.e., the interaction term). 

(If you are struggling, please try to sketch out what the graph will look like, similar to what we did in lecture and in the midterm).

According to this interactive model, what is the average price of a home in a neighborhood next to the river, with a pupil-to-teacher ratio that is one standard deviation better than the mean? 

[4 marks]

```{r q2c, echo=TRUE}
fit2 = lm(MedianValueInThousands ~ PupilTeacherRatio + PupilTeacherRatio*BordersRiver, d2)
summary(fit2)

63.1253 + (-0.3632)*(16.29058) -28.3322
```

<p style="color:blue">
Coefficient of PupilTeacherRatio = -2.2147. Every unit increase of PupilTeacherRatio decreases the medianValue of homes by 2.2147 thousand dollars given all other predictors constant.  
The p-value=2e-16 is very small,(< 0.05), thus we have sufficient evidence to reject the null hypothesis that the intercept is 0 and conclude that the slope parameter is statistically significant at the 5% level of confidence.  
<br>
Coefficient of PupilTeacherRatio:BordersRiver = 1.8515. This means that when the house borders river and the pupilteacherratio increase by 1 unit, the median value of homes increase by 1.8515 thousand compared to when the house do not borders river and the pupilteacher by 1 unit. Or the house value decrease by 2.2147 - 1.8515 = 0.3632 thousand dollars when the pupilteacherratio increase by 1 unit and the home borders river.
The p-value=0.00559 is very small,(< 0.05), thus we have sufficient evidence to reject the null hypothesis that the intercept is 0 and conclude that the slope parameter is statistically significant at the 5% level of confidence.  
<br>
According to this interactive model, the average price of a home in a neighborhood next to the river, with a pupil-to-teacher ratio that is one standard deviation better than the mean is : 63.1253 + (-0.3632)*(16.29058) -28.3322 =  28.87636 thousand dollars.  
</p>


# Structured Question 3 [Total 13 marks, marks indicated for each sub-question]

Your friend Matthew has just set up his own café. He is very passionate about coffee, and would like to sell two of his specially developed blends: the Signature blend and the Summit blend. He uses the following recipe:

Signature Blend: 0.5kg Sumatran + 0.5kg Colombian,sold for $60.  
Summit Blend: 0.3kg Colombian + 0.7kg Blue Mountain Coffee Bean sold for $80.  

Sumatran coffee beans cost \$20 per kilogram, Colombian coffee beans cost \$35 per kilogram and Blue Mountain coffee bean cost \$50 per kilogram. 

Matthew can secure 40kg of Sumatran coffee beans, 50kg of Colombian coffee beans and 30kg of Blue Mountain coffee beans each week from his supplier. 

Furthermore, Matthew is a popular barista and will be able to sell all of the blends that he produces. However, he has never run a business before and is unsure how much of each blend he should prepare to maximize his profit. You realize that you can help Matthew formulate this as an optimization problem.


Please also add all the code you write into the textbox, and please ignore all integer constraints in the question.


#### (a) 

Please write down the scenario as an optimization problem and show all workings (as we usually do in tutorial and lecture). 

What is the optimal profit, and what is the optimal product mix? Additionally, write your recommendation to Matthew in simple terms. 

[7 marks]

Maximize total profit using decision variables $X_1$, $X_2$ = number of Signature Blend and Summit Blend respectively  | Profit = 32.5$X_1$ + 34.5$X_2$
--- | --- 
Subject to |
Sumatran Weight Constraint | 0.5$X_1$ + 0$X_2$ $\leq$ 40
Colombian Weight Constraint | 0.5$X_1$ + 0.3$X_2$ $\leq$ 50
Blue Mountain Weight Constraint | 0$X_1$ + 0.7$X_2$ $\leq$ 30
Non-Negativity Constraints | $X_1$, $X_2$ > 0


```{r q3a,echo=T}
# defining parameters 
objective.fn = c(32.5,34.5)
const.mat = matrix(c(0.5,0,
                     0.5,0.3,
                     0,0.7), ncol = 2, byrow = TRUE)
const.dir = c(rep('<=', 3))
const.rhs = c(40,50,30)

# solving the linear problem
lp.solution = lp(direction = 'max', objective.fn, 
              const.mat, const.dir, const.rhs,
              compute.sens = TRUE)
print(lp.solution$solution)
print(lp.solution)


```

<p style="color:blue">
The optimal profit is $3892.857.  
The optimal product mix is 74.28571 signature blend and 42.85714 Summit blend.  
Matthew should product 74.28571kg of signature blend and 42.85714kg of Summit blend to get the most profit at $3892.857.  
</p>



#### (b) 

Print out the shadow prices ($duals) of your solution to the previous part, and write an interpretation for each. Which constraints are binding? 

[3 marks]

```{r q3b,echo=T}
lp.solution$duals
```

<p style="color:blue">
Shadow price of Sumatran Weight Constraint is $0. An increase of 1kg that matthew can obtain for Sumatran coffee beans will not improve profit.  
Shadow price of Colombian Weight Constraint is $65. An increase of 1kg that matthew can obtain for Colombian coffee beans will improve profit by \$65.  
Shadow price of Blue Mountain Weight Constraint is $21.42857. An increase of 1kg that matthew can obtain for Blue Mountain coffee beans will improve profit by \$21.43(2d.p)  
Non-Negativity Constraint for all Sumatran, Colombian and Blue Mountain are non-binding. Therefore, the shadow prices are $0.  
</p>

#### (c) 

The Summit blend is a hit with Matthew’s customers. Is it possible for Matthew to prepare more of the Summit blend each week? Why or why not? What would he need to do? 
```{r q3c, echo=T}
range.objcoef = cbind(lp.solution$sens.coef.from, lp.solution$sens.coef.to)
rownames(range.objcoef) = c('coef x1', 'coef x2')
colnames(range.objcoef) = c('from', 'to')
print(round(range.objcoef, 1))
```
[3 marks]

<p style="color:blue">
Since the weight constrain of Colombian and blue mountain, 2 of the key ingredient of summit blend are binding, there is no more of those beans left to mix summit. If he use more Colombian beans to create summit, this will cause less signature blend to be created, which will decrease the optimal profit. Thus we cannot prepare more of summit blend.  
If he want to prepare more summit blend, he need to be able to secure more of Colombian coffee beans and blue mountain coffee beans. This will not only allow him to produce more summit blend, it also increases his optimal profit from the drinks.
</p>



